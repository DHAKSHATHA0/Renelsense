# IP Address Configuration Guide

This guide explains how to run the Smart Kidney Monitoring System on a network IP address instead of localhost, allowing the website, ML API, and hardware device to communicate over the same network.

## Architecture Overview

```
Network IP (e.g., 192.168.1.100)
│
├─ Website Server (Port 3000)
│  └─ Node.js Express Server
│
├─ ML API (Port 5000)
│  └─ External Python/ML System
│
└─ Hardware Device (ESP32 WiFi)
   └─ Sends sensor data to Port 3000
```

## Quick Start

### 1. **Start the Website Server**

The server automatically detects your network IP and configures both the website and ML API endpoints.

```bash
npm start
```

**Output will show:**
```
========================================
Server running on http://192.168.x.x:3000
WebSocket server running on ws://192.168.x.x:3000
Local: http://localhost:3000
ML API: http://192.168.x.x:5000
========================================
```

### 2. **Access the Website**

Open your browser and navigate to the IP address shown in the server output:
- **From same network:** `http://192.168.x.x:3000`
- **From localhost:** `http://localhost:3000`

## Configuration Methods

### Method 1: Automatic (Default - Recommended)

The server automatically detects your network IP address and configures everything:

```bash
npm start
```

- ✅ Website loads from detected network IP
- ✅ ML API defaults to same network IP (Port 5000)
- ✅ Hardware device connects to network IP
- ✅ Config saved to `public/config.json`

### Method 2: Environment Variables

Set custom IP addresses using environment variables:

```bash
# Windows PowerShell
$env:SERVER_IP = "192.168.1.100"
$env:ML_API_IP = "192.168.1.101"
$env:ML_API_PORT = "5000"
npm start
```

```bash
# Windows Command Prompt
set SERVER_IP=192.168.1.100
set ML_API_IP=192.168.1.101
set ML_API_PORT=5000
npm start
```

```bash
# Linux/Mac
export SERVER_IP=192.168.1.100
export ML_API_IP=192.168.1.101
export ML_API_PORT=5000
npm start
```

### Method 3: Batch File (Windows)

Edit `start-server.bat`:

```batch
@echo off
set SERVER_IP=192.168.1.100
set ML_API_IP=192.168.1.101
set ML_API_PORT=5000
npm start
```

## ML API Setup

### If ML API Runs on Same Machine

1. **Start the ML API server** (Python Flask on Port 5000):
   ```bash
   cd ml_api
   python app.py
   ```

2. **Start the website server**:
   ```bash
   npm start
   ```

The website will automatically discover and connect to the ML API.

### If ML API Runs on Different Machine

Set the ML API IP address explicitly:

```bash
# PowerShell
$env:ML_API_IP = "192.168.1.101"  # ML server IP
npm start
```

**Important:** The ML API and website server should be on the same network.

## Hardware Device (ESP32) Configuration

Update the ESP32 sketch to point to the website server IP:

In `ESP32_WiFi_Sketch.ino`, set:

```cpp
const char* serverIP = "192.168.x.x";     // Website server IP
const int serverPort = 3000;              // Website server port
const char* mlApiIP = "192.168.x.x";      // ML API server IP
const int mlApiPort = 5000;               // ML API port
```

The ESP32 will:
- ✅ Connect to WiFi
- ✅ Send sensor data to `http://192.168.x.x:3000/api/sensor-data`
- ✅ Receive real-time updates via WebSocket

## Network Compatibility

### Required for Devices to Communicate

1. **Same WiFi Network:** All devices must be on the same WiFi network
2. **No Firewall Blocking:** Ensure ports 3000 and 5000 are not blocked
3. **Stable Connection:** All devices should have stable network connectivity

### Testing Connectivity

#### From Another Device on Network

```bash
# Test website
http://192.168.x.x:3000

# Test ML API
curl http://192.168.x.x:5000/health
```

#### From Same Machine

```bash
# Open browser
http://localhost:3000
http://127.0.0.1:3000
```

## Config File Reference

The server creates `public/config.json` automatically:

```json
{
  "serverIP": "192.168.1.100",
  "serverPort": 3000,
  "mlApiIP": "192.168.1.100",
  "mlApiPort": 5000,
  "timestamp": "2025-12-27T10:30:00.000Z",
  "notes": "Auto-generated by server.js"
}
```

**Frontend loads this config** to:
- ✅ Connect to correct server IP
- ✅ Connect to correct ML API
- ✅ Enable WebSocket communication

## Troubleshooting

### Issue: "Cannot reach server from another device"

**Solution:**
1. Check if server is running: `http://192.168.x.x:3000`
2. Verify network connectivity: Can you ping the server machine?
3. Check firewall settings on server machine
4. Ensure port 3000 is not blocked

### Issue: "ML API connection fails"

**Solution:**
1. Verify ML API is running on Port 5000
2. Check ML API IP in server output
3. Set correct ML_API_IP environment variable
4. Restart server after changing environment variables

### Issue: "WebSocket connection refused"

**Solution:**
1. Ensure server is running
2. Check browser console for error messages
3. Verify WebSocket protocol: `ws://` (not `wss://`)
4. Check firewall allows WebSocket connections

### Issue: "Hardware device cannot send data"

**Solution:**
1. Verify ESP32 is on same WiFi network
2. Check ESP32 has correct server IP hardcoded
3. Verify ESP32 can ping the server machine
4. Check server logs for incoming sensor data

## Advanced Configuration

### Custom Ports

To run on different ports, modify `server.js`:

```javascript
const PORT = process.env.PORT || 3000;
```

Change to:
```javascript
const PORT = process.env.PORT || 8080;  // Custom port
```

### CORS Configuration

If frontend and backend are on different IPs, CORS is already enabled in `server.js`:

```javascript
app.use(cors());  // Allows cross-origin requests
```

### WebSocket Over Secure Connection

For production, enable WSS (WebSocket Secure):

```javascript
const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
return `${protocol}//${this.serverIP}:${this.serverPort}`;
```

## Production Deployment

### Setting Static IP for Server Machine

#### Windows

```bash
# Set static IP in Network Settings
Settings > Network & Internet > WiFi > Properties > IP settings > Edit > Manual
```

#### Linux

```bash
# Edit netplan configuration
sudo nano /etc/netplan/01-netcfg.yaml
```

### Environment Setup

Create `.env` file:

```bash
SERVER_IP=192.168.1.100
ML_API_IP=192.168.1.101
ML_API_PORT=5000
PORT=3000
```

Then start server:

```bash
# Using npm-dotenv
npm install dotenv --save
node -r dotenv/config server.js
```

## Summary

| Feature | Status | Details |
|---------|--------|---------|
| Auto IP Detection | ✅ | Automatic on server start |
| Custom IP via ENV | ✅ | Set SERVER_IP variable |
| ML API Discovery | ✅ | Auto-configures to server IP |
| Hardware Support | ✅ | ESP32 can post to network IP |
| WebSocket Support | ✅ | Enabled for real-time updates |
| Cross-Network | ✅ | CORS enabled for external access |

**All devices (website, ML API, hardware) should be accessible on the same network IP for optimal performance.**
